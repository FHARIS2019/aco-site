/*! dlts-aco 2014-07-27 */
YUI.add("crossframe",function(Y){var _openerObject,_retryCounter=0,PATTERN=/top|parent|opener|frames\[(?:(?:['"][a-zA-Z\d-_]*['"])|\d+)\]/,DEFAULT_EVENT="crossframe:message",MODULE_ID="CrossFrame",RETRY_AMOUNT=10,SUCCESS_MESSAGE="__SUCCESS_CALLBACK__",_onMessage,_bindOpener,_init,_messageCallbackAdapter,_postMessageByOpener,addPublisher,appendFrame,postMessage,set,setOpener,messageReceiveAdapter,messageReceiveEvent;_onMessage=function(a,b){var c={},d=null,e=null,f=Y.QueryString.parse(a.data),g=f.tid,h=f.message,i=f.eventType,j=f.target,k=f.url;if(decodeURIComponent(h)!==SUCCESS_MESSAGE)c={type:i,data:a.data,origin:a.origin,lastEventId:a.lastEventId,source:a.source,ports:a.ports},d=function(c){var d,e;e=[];for(d in c)if(c.hasOwnProperty(d)){if("url"===d||"target"===d||"tid"===d||"message"===d)continue;c[d]=c[d].toString(),e.push(d+"="+encodeURIComponent(c[d]))}url=["url="+encodeURIComponent(k),"target="+encodeURIComponent(j),"tid="+g,"message="+encodeURIComponent(Y.CrossFrame.SUCCESS_MESSAGE)].join("&"),b?window.opener.messageCallbackAdapter(url+"&"+e.join("&")):a.source.postMessage(url+"&"+e.join("&"),"*")},i&&(e=addPublisher(i),e.fire(i,c,f,d)),messageReceiveEvent.fire(DEFAULT_EVENT,c,f,d);else try{window[g](f)}catch(l){Y.log(l.message,"error",MODULE_ID)}},_bindOpener=function(){return Y.log("_bindOpener() is executed.","info",MODULE_ID),"undefined"==typeof window.opener||"undefined"==typeof window.opener.messageCallbackAdapter?void Y.later(100,null,arguments.callee):void(window.opener.messageReceiveAdapter=messageReceiveAdapter)},_init=function(){Y.log("_init(): is executed","info",MODULE_ID),"undefined"!=typeof window.addEventListener?window.addEventListener("message",_onMessage,!1):"undefined"!=typeof window.attachEvent&&Y.UA.ie>=8?window.attachEvent("onmessage",_onMessage):Y.log("_init(): This browser doesn't support onmessage event.","info",MODULE_ID)},_messageCallbackAdapter=function(a){var b=Y.QueryString.parse(a);decodeURIComponent(b.message)===SUCCESS_MESSAGE&&window[b.tid](b)},_postMessageByOpener=function(a,b){return"undefined"==typeof _openerObject.messageReceiveAdapter?(_retryCounter++,_retryCounter>RETRY_AMOUNT?(Y.log("_postMessageByOpener() - It fails because target frame have no window.opener.messageReceiveAdapter.","info",MODULE_ID),void appendFrame(b+"#"+a)):void Y.later(100,null,arguments.callee,[a,b])):(_openerObject.messageReceiveAdapter(a,window),void(_retryCounter=0))},addPublisher=function(a,b){Y.log("addPublisher() is executed.","info",MODULE_ID);var c=new Y.EventTarget;return b=b||"",c.name=b,c.publish(a,{broadcast:2,emitFacade:!0}),c},appendFrame=function(a){Y.log("appendFrame(): is executed","info",MODULE_ID);var b,c,d;b=document.createElement("iframe"),b.style.position="absolute",b.style.top="0",b.style.left="0",b.style.visibility="hidden",b.style.width="0",b.style.height="0",document.body.appendChild(b),c=Y.one(b),d=c.on("load",function(){Y.detach(d),Y.later(1e3,null,function(){document.body.removeChild(b)})}),b.src=a,document.body.appendChild(b)},postMessage=function(target,message,config){Y.log("postMessage(): is executed","info",MODULE_ID);var pattern=/frames\[['"](^].)['"]\]/gi;if(!target||!message)return void Y.log("You have to provide both target and message arguments.","error",MODULE_ID);if(!Y.Lang.isObject(target)&&!PATTERN.test(target))return void Y.log("Frame string format error!\n"+target,"error",MODULE_ID);config=config||{},config.callback=config.callback||function(){},config.proxy=config.proxy||null,config.reverseProxy=config.reverseProxy||null,config.eventType=config.eventType||null,config.useProxy=config.useProxy===!0||!1,"Object"==typeof message&&(message=Y.JSON.stringify(message));var dataString,frameString,isSupport,openerObject,tId,origin,ports;tId=parseInt((new Date).getTime(),10);try{origin=location.host.toString()}catch(e){origin=""}try{ports=location.port.toString()}catch(e2){ports=""}switch(dataString=["tid="+tId,"eventType="+encodeURIComponent(config.eventType),"target="+encodeURIComponent(target),"message="+encodeURIComponent(message),"domain="+encodeURIComponent(document.domain),"url="+encodeURIComponent(location.href),"reverseProxy="+encodeURIComponent(config.reverseProxy),"useProxy="+config.useProxy,"source="+encodeURIComponent(window.name),"origin="+origin,"ports="+ports].join("&"),window[tId]=function(a){delete a.message,delete a.target,delete a.tid,delete a.url,config.callback(a)},isSupport=Y.UA.ie&&Y.UA.ie<8?!1:!0,isSupport="undefined"==typeof window.postMessage?!1:isSupport,isSupport="opener"===target&&Y.UA.ie?!1:isSupport,isSupport=config.useProxy?!1:isSupport){case!1:if("opener"!==target&&!config.useProxy)return Y.log("postMessage() - You are using opener hack approach.","info",MODULE_ID),_openerObject||(_openerObject={},_openerObject.messageCallbackAdapter=_messageCallbackAdapter,target=eval(target),target.opener=_openerObject),void _postMessageByOpener(dataString,config.proxy);if(!config.proxy)return void Y.log("You can't use Y.CrossFrame.postMessage in this legend browser without providing proxy URL","error",MODULE_ID);Y.log("postMessage() - You are using iframe in iframe approach.","info",MODULE_ID),appendFrame(config.proxy+"#"+dataString);break;case!0:try{target=eval(target)}catch(e){return void Y.log(e.message,"error",MODULE_ID)}target.postMessage(dataString,"*")}return tId},set=function(a,b){switch(a){case"receiver":if("undefined"!=typeof window.postMessage)return;b===!0&&_bindOpener()}},setOpener=function(a){if("undefined"==typeof window.postMessage)if(window.name.toString()===a)_bindOpener();else{var b=document.getElementByName(a);b||Y.error("The target iframe doesn't exist"),_openerObject={},_openerObject.messageCallbackAdapter=_messageCallbackAdapter,b.contentWindow.opener=_openerObject}},messageReceiveAdapter=function(a,b){Y.log("messageReceiveAdapter() is executed.","info",MODULE_ID);var c={},d=Y.QueryString.parse(a);c={type:d.eventType,data:a,origin:d.origin,lastEventId:d.tid,source:b,ports:d.ports},_onMessage(c,b)},messageReceiveEvent=function(){return Y.log("messageReceiveEvent(): is executed","info",MODULE_ID),addPublisher(DEFAULT_EVENT,"Cross-frame Message Publisher")}(),Y.CrossFrame={SUCCESS_MESSAGE:SUCCESS_MESSAGE,addPublisher:addPublisher,appendFrame:appendFrame,messageReceiveAdapter:messageReceiveAdapter,messageReceiveEvent:messageReceiveEvent,postMessage:postMessage,set:set,setOpener:setOpener},_init()},"3.2.0",{group:"mui",js:"crossframe/crossframe.js",requires:["node-base","event-custom","querystring-parse","json-stringify"]});